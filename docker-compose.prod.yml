services:
  # Backend NestJS 앱
  backend:
    image: sgwar/genkun-backend:latest  # DockerHub 이미지
    container_name: genkun-backend
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      NODE_ENV: production
      PORT: 5000

      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES: ${JWT_EXPIRES:-1d}

      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_CALLBACK: ${GOOGLE_CALLBACK}

      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY}

      # CORS
      CORS_ORIGIN_LIST: ${CORS_ORIGIN_LIST}

      # Admin
      ADMIN_USER: ${ADMIN_USER:-root}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-root}
      SECRET_KEY: ${SECRET_KEY}

    volumes:
      - ./uploads:/app/uploads  # 파일 업로드 저장소

    depends_on:
      - postgres
      - redis

    networks:
      - genkun-network

  # 2. Worker (BullMQ Processor 전용)
  worker:
    image: sgwar/genkun-backend:latest
    container_name: genkun-worker
    restart: unless-stopped
    command: ["node", "dist/worker.js"]   # 핵심
    environment:
      NODE_ENV: production

      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}

      REDIS_HOST: redis
      REDIS_PORT: 6379

      OPENAI_API_KEY: ${OPENAI_API_KEY}

    volumes:
      - ./uploads:/app/uploads

    depends_on:
      - redis
      - postgres

    networks:
      - genkun-network

  # PostgreSQL
  postgres:
    image: postgres:15-alpine
    container_name: genkun-postgres
    restart: unless-stopped
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - genkun-network

  # Redis
  redis:
    image: redis:alpine
    container_name: genkun-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - genkun-network

volumes:
  postgres_data:

networks:
  genkun-network:
    driver: bridge
